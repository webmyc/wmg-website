---
// SignupForm component with Formspree integration
---

<section id="signup" aria-labelledby="join" class="py-20 px-6 bg-wmg-bg">
  <div class="max-w-2xl mx-auto">
    <h2 id="join" class="text-3xl md:text-4xl font-bold text-wmg-text mb-6 text-center fade-up">
      Join the forming community
    </h2>
    
    <p class="text-lg md:text-xl text-wmg-text/80 mb-12 text-center fade-up">
      Get the live gathering link and monthly updates.
    </p>
    
    <form 
      class="space-y-6 fade-up"
      action={`https://formspree.io/f/${import.meta.env.PUBLIC_FORMSPREE_ID || 'your-formspree-id'}`}
      method="POST"
      id="signup-form"
    >
      <!-- Honeypot field -->
      <input 
        type="text" 
        name="_gotcha" 
        style="display: none" 
        tabindex="-1" 
        autocomplete="off"
        aria-hidden="true"
      />
      
      <div class="space-y-4">
        <div>
          <label for="name" class="block text-wmg-text font-medium mb-2">
            Name *
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-3 bg-wmg-text/10 border border-wmg-text/20 rounded-lg text-wmg-text placeholder-wmg-text/50 focus:outline-none focus:ring-2 focus:ring-wmg-gold focus:border-transparent transition-colors"
            placeholder="Your full name"
            aria-describedby="name-error"
          />
          <div id="name-error" class="text-red-400 text-sm mt-1 hidden" role="alert"></div>
        </div>
        
        <div>
          <label for="email" class="block text-wmg-text font-medium mb-2">
            Email *
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 bg-wmg-text/10 border border-wmg-text/20 rounded-lg text-wmg-text placeholder-wmg-text/50 focus:outline-none focus:ring-2 focus:ring-wmg-gold focus:border-transparent transition-colors"
            placeholder="your.email@example.com"
            aria-describedby="email-error"
          />
          <div id="email-error" class="text-red-400 text-sm mt-1 hidden" role="alert"></div>
        </div>
      </div>
      
      <button
        type="submit"
        class="w-full bg-wmg-gold text-wmg-bg px-8 py-4 text-lg font-semibold rounded-lg hover:bg-wmg-gold/90 focus:outline-none focus:ring-4 focus:ring-wmg-gold/50 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
        id="submit-btn"
      >
        <span id="submit-text">Join Us</span>
        <span id="submit-loading" class="hidden">Joining...</span>
      </button>
      
      <!-- Success/Error messages -->
      <div id="form-message" class="text-center mt-4 hidden" role="alert" aria-live="polite"></div>
    </form>
  </div>
</section>

<script>
  import { trackFormEvent, trackButtonClick } from '../lib/analytics.ts';
  
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('signup-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const submitText = document.getElementById('submit-text') as HTMLElement;
    const submitLoading = document.getElementById('submit-loading') as HTMLElement;
    const formMessage = document.getElementById('form-message') as HTMLElement;
    const nameInput = document.getElementById('name') as HTMLInputElement;
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const nameError = document.getElementById('name-error') as HTMLElement;
    const emailError = document.getElementById('email-error') as HTMLElement;

    function showError(input: HTMLInputElement, errorElement: HTMLElement, message: string) {
      input.classList.add('border-red-400');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }

    function clearError(input: HTMLInputElement, errorElement: HTMLElement) {
      input.classList.remove('border-red-400');
      errorElement.classList.add('hidden');
    }

    function showMessage(message: string, isError = false) {
      formMessage.textContent = message;
      formMessage.className = `text-center mt-4 ${isError ? 'text-red-400' : 'text-wmg-gold'}`;
      formMessage.classList.remove('hidden');
    }

    function hideMessage() {
      formMessage.classList.add('hidden');
    }

    // Real-time validation
    nameInput.addEventListener('blur', function() {
      if (this.value.trim().length < 2) {
        showError(this, nameError, 'Name must be at least 2 characters');
      } else {
        clearError(this, nameError);
      }
    });

    emailInput.addEventListener('blur', function() {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(this.value)) {
        showError(this, emailError, 'Please enter a valid email address');
      } else {
        clearError(this, emailError);
      }
    });

    // Track form start when user begins typing
    let formStarted = false;
    [nameInput, emailInput].forEach(input => {
      input.addEventListener('input', () => {
        if (!formStarted) {
          formStarted = true;
          trackFormEvent('start', 'signup_form');
        }
      });
    });

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      hideMessage();
      
      trackFormEvent('submit', 'signup_form', {
        has_name: nameInput.value.trim().length > 0,
        has_email: emailInput.value.trim().length > 0
      });

      // Clear previous errors
      clearError(nameInput, nameError);
      clearError(emailInput, emailError);

      // Basic validation
      let hasErrors = false;
      if (nameInput.value.trim().length < 2) {
        showError(nameInput, nameError, 'Name must be at least 2 characters');
        hasErrors = true;
      }
      
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailInput.value)) {
        showError(emailInput, emailError, 'Please enter a valid email address');
        hasErrors = true;
      }

      if (hasErrors) return;

      // Show loading state
      submitBtn.disabled = true;
      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          showMessage('Welcome to the gathering! You\'ll receive the live link and updates soon.');
          form.reset();
          trackFormEvent('submit', 'signup_form', { status: 'success' });
        } else {
          throw new Error('Form submission failed');
        }
      } catch (error) {
        showMessage('Something went wrong. Please try again.', true);
        trackFormEvent('error', 'signup_form', { error: 'submission_failed' });
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    });
  });
</script>

<style>
  .fade-up {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }
  
  .fade-up.reveal {
    opacity: 1;
    transform: translateY(0);
  }
</style>
